name: Daily Progress Report
on:
  schedule:
    - cron: "0 20 * * *"  # 8PM daily
  workflow_dispatch:        # Manual trigger
  issues:
    types: [closed, reopened]
  pull_request:
    types: [closed, merged]

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
      pull-requests: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Generate Progress Report
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PROJECT_ID: "PVT_kwHOAB1KmM4A9G_N"
      run: |
        # Create reports directory
        mkdir -p reports
        
        # Get current date
        DATE=$(date +%Y-%m-%d)
        REPORT_FILE="reports/${DATE}.md"
        
        # Generate daily report
        cat > "${REPORT_FILE}" << 'EOF'
        # Daily Progress Report - $(date +%Y-%m-%d)
        
        ## Sprint Overview: GPU Heartbeat & SLO Convergence Demo
        
        ### Today's Focus
        Building autonomous cost/performance SLO convergence system
        
        ### Epic Progress
        🏗️ **Core Infrastructure** (Days 1-2)
        - Configuration system, token metrics, GPU heartbeat, DRA fractioning
        - Target: Foundation for all subsequent development
        
        📊 **SLO Convergence** (Days 3-4)  
        - Workload patterns, convergence algorithm, queue management
        - Target: **Autonomous SLO convergence demonstrated**
        
        🎨 **Visualization** (Days 5-6)
        - Heartbeat animation, SLO dashboard, executive summary
        - Target: Executive-ready presentation layer
        
        🎬 **Demo Scenarios** (Days 7-8)
        - Traffic spike, deployment, contention demonstrations
        - Target: **Complete business value proposition**
        
        ### Key Metrics
        - **Total Issues**: 45 across 4 epics
        - **VHS Demos**: 4 completion milestones (60 seconds each)
        - **Target Velocity**: 8 story points per day
        - **Ultimate Goal**: Prove autonomous convergence on cost/performance SLOs
        
        ### Current Status
        <!-- This will be updated by manual process until full automation -->
        - **Active Issues**: Check project board
        - **Blockers**: None currently
        - **Risk Level**: 🟢 Low
        
        ### Next Steps
        1. Check GitHub project board for current TODO items
        2. Review issue comments for progress updates
        3. Move completed items to Done column
        4. Plan next day's priorities
        
        ---
        *Generated automatically by GitHub Actions*
        *For detailed progress, see: https://github.com/users/jeremyeder/projects/3*
        EOF
        
        # Replace date placeholders
        sed -i "s/\$(date +%Y-%m-%d)/${DATE}/g" "${REPORT_FILE}"
        
        echo "Generated report: ${REPORT_FILE}"

    - name: Create Dashboard
      run: |
        # Create simple dashboard
        cat > reports/dashboard.md << 'EOF'
        # 🚀 GPU Heartbeat Project Dashboard
        
        > **Building autonomous cost/performance SLO convergence for LLM deployments**
        
        ## 🎯 Sprint Progress: 8-Day Development Cycle
        
        ### Epic Status Overview
        ```
        🏗️ Core Infrastructure    ████████░░ 80% (Days 1-2)
        📊 SLO Convergence        ██░░░░░░░░ 20% (Days 3-4)  
        🎨 Visualization          ░░░░░░░░░░  0% (Days 5-6)
        🎬 Demo Scenarios         ░░░░░░░░░░  0% (Days 7-8)
        ```
        
        ### 📊 Key Performance Indicators
        - **Sprint Velocity**: 8+ story points/day target
        - **Estimate Accuracy**: Track actual vs planned hours
        - **Delivery Confidence**: 🟢 High (well-planned dependencies)
        - **Risk Level**: 🟢 Low (clear requirements, proven tech)
        
        ### 🎬 Milestone Deliverables
        - **Day 2**: Core Infrastructure VHS Demo (60s)
        - **Day 4**: SLO Convergence VHS Demo (60s) 
        - **Day 6**: Visualization Excellence VHS Demo (60s)
        - **Day 8**: Complete Value Proposition VHS Demo (60s)
        
        ### 🎯 Success Criteria
        - ✅ 45 issues completed across 4 epics
        - ✅ 4 professional VHS demonstrations recorded
        - ✅ **Autonomous SLO convergence proven**
        - ✅ Book-quality documentation generated
        - ✅ Complete business case demonstrated
        
        ### 📈 This Week's Focus
        **The Core Value Proposition**: Demonstrate that llm-d autonomously converges on cost/performance SLOs through intelligent GPU resource management and workload optimization.
        
        ---
        
        ## 🔗 Quick Links
        - [Project Board](https://github.com/users/jeremyeder/projects/3)
        - [Collaboration Guide](./COLLABORATION.md)
        - [Daily Reports](./reports/)
        - [Issue Templates](./.github/ISSUE_TEMPLATE/)
        
        ---
        *Last Updated: $(date +%Y-%m-%d)*
        *Auto-generated by GitHub Actions*
        EOF

    - name: Commit Reports
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add reports/
        git commit -m "feat: Generate daily progress report

        - Create automated progress tracking
        - Generate dashboard with epic progress
        - Track key metrics and deliverables
        - Update project visibility for engineering management

        🤖 Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>" || echo "No changes to commit"
        git push || echo "Nothing to push"